# AIモデル判定ロジック仕様書

最終更新: 2025年1月28日

## 概要

本アプリケーションで使用するAI音声認識モデルの判定ロジックについて説明します。モデルは104クラスの出力を持ちますが、実際に使用するのは0-100のインデックス（101文字）のみです。

## モデル仕様

### 基本仕様
- **出力形状**: 104クラス（float32の確率配列）
- **使用クラス**: 0-100のインデックス（101文字）
- **未使用クラス**: 101-103のインデックス（末尾3クラス）

### 文字マッピング（0-100）

```typescript
{
  "0": "あ", "1": "い", "2": "う", "3": "え", "4": "お",
  "5": "か", "6": "が", "7": "き", "8": "きゃ", "9": "きゅ", "10": "きょ", 
  "11": "ぎ", "12": "ぎゃ", "13": "ぎゅ", "14": "ぎょ", 
  "15": "く", "16": "ぐ", "17": "け", "18": "げ", "19": "こ", "20": "ご",
  "21": "さ", "22": "ざ", "23": "し", "24": "しゃ", "25": "しゅ", "26": "しょ", 
  "27": "じ", "28": "じゃ", "29": "じゅ", "30": "じょ", 
  "31": "す", "32": "ず", "33": "せ", "34": "ぜ", "35": "そ", "36": "ぞ",
  "37": "た", "38": "だ", "39": "ち", "40": "ちゃ", "41": "ちゅ", "42": "ちょ", 
  "43": "つ", "44": "て", "45": "で", "46": "と", "47": "ど",
  "48": "な", "49": "に", "50": "にゃ", "51": "にゅ", "52": "にょ", 
  "53": "ぬ", "54": "ね", "55": "の",
  "56": "は", "57": "ば", "58": "ぱ", "59": "ひ", "60": "ひゃ", "61": "ひゅ", "62": "ひょ", 
  "63": "び", "64": "びゃ", "65": "びゅ", "66": "びょ", 
  "67": "ぴ", "68": "ぴゃ", "69": "ぴゅ", "70": "ぴょ", 
  "71": "ふ", "72": "ぶ", "73": "ぷ", "74": "へ", "75": "べ", "76": "ぺ", 
  "77": "ほ", "78": "ぼ", "79": "ぽ",
  "80": "ま", "81": "み", "82": "みゃ", "83": "みゅ", "84": "みょ", 
  "85": "む", "86": "め", "87": "も",
  "88": "や", "89": "ゆ", "90": "よ",
  "91": "ら", "92": "り", "93": "りゃ", "94": "りゅ", "95": "りょ", 
  "96": "る", "97": "れ", "98": "ろ",
  "99": "わ", "100": "ん"
}
```

### 同一音として統合された文字

AIモデルは以下の文字を同一音として扱い、矢印の先の文字として出力します：

- **「づ」→「ず」** (インデックス32)
- **「ぢ」→「じ」** (インデックス27)
- **「を」→「お」** (インデックス4)

これらの文字（「づ」「ぢ」「を」）は、モデルの出力クラスには含まれていません。

## 判定ロジック

### 1. 基本的な推論フロー

```typescript
1. 音声データ（2秒、16kHz）を受け取る
2. 前処理（正規化、パディング）を実行
3. TensorFlow Liteモデルで推論（104クラスの確率配列を取得）
4. 0-100のインデックスのみを使用してTop-3を計算
5. 正解判定ロジックを適用
```

### 2. Top-3判定

モデルの出力から確率の高い上位3つの予測を取得します：

```typescript
// 確率配列の0-100インデックスのみを使用
const probabilityPairs = probabilities.slice(0, 101).map((prob, index) => ({
  character: CLASS_LABELS[index],
  confidence: prob,
  index: index
}));

// 確率の高い順にソート
probabilityPairs.sort((a, b) => b.confidence - a.confidence);
const top3 = probabilityPairs.slice(0, 3);
```

### 3. 正解判定ロジック

正解判定は以下の3段階で行われます：

#### 段階1: 直接一致
入力文字がTop-3に含まれている場合は正解とする

```typescript
if (top3Characters.includes(character)) {
  isCorrect = true;
}
```

#### 段階2: 同一扱い文字のチェック
入力文字が同一扱い文字の場合、その対応文字がTop-3に含まれていれば正解とする

```typescript
const IDENTICAL_PAIRS = {
  'を': 'お',
  'お': 'を',
  'ず': 'づ',
  'づ': 'ず',
  'じ': 'ぢ',
  'ぢ': 'じ'
};

const identicalChar = IDENTICAL_PAIRS[character];
if (identicalChar && top3Characters.includes(identicalChar)) {
  isCorrect = true;
}
```

#### 段階3: 類似ラベルのチェック
AIが頻繁に間違える類似文字ペアを考慮

```typescript
const SIMILAR_PAIRS = {
  'ぎ': ['じ'],              // 「ぢ」は「じ」として出力される
  'じ': ['ぎ'],         
  'ぢ': ['ぎ', 'じ'],        // 入力が「ぢ」の場合の判定用
  'ぎゅ': ['じゅ', 'ず'],     // 「づ」は「ず」として出力される
  'じゅ': ['ぎゅ', 'ず'], 
  'ず': ['ぎゅ', 'じゅ', 'しょ', 'す'], 
  'づ': ['ぎゅ', 'じゅ', 'ず'], // 入力が「づ」の場合の判定用
  'は': ['ほ'],
  'ほ': ['は'],
  'ぱ': ['ぷ'],
  'ぷ': ['ぱ'],
  // ... その他の類似ペア
};

const similarLabels = SIMILAR_PAIRS[character] || [];
if (similarLabels.some(label => top3Characters.includes(label))) {
  isCorrect = true;
}
```

## 具体例

### 例1: 「づ」の判定
- **入力**: 「づ」
- **AIモデルの出力**: 「ず」（インデックス32）として返される
- **判定**: IDENTICAL_PAIRS により「づ」→「ず」の関係が定義されているため、正解と判定

### 例2: 「ぢ」の判定
- **入力**: 「ぢ」
- **AIモデルの出力**: 「じ」（インデックス27）として返される
- **判定**: IDENTICAL_PAIRS により「ぢ」→「じ」の関係が定義されているため、正解と判定

### 例3: 「を」の判定
- **入力**: 「を」
- **AIモデルの出力**: 「お」（インデックス4）として返される
- **判定**: IDENTICAL_PAIRS により「を」→「お」の関係が定義されているため、正解と判定

### 例4: 類似文字の判定
- **入力**: 「ぎ」
- **AIモデルのTop-3出力**: 「じ」「ぎ」「き」
- **判定**: 「ぎ」がTop-3に含まれているため正解、または「じ」が類似文字として定義されているため正解

## 注意事項

1. **モデル出力の制限**
   - 104クラスの出力のうち、インデックス101-103は使用しない
   - 実際の判定は0-100のインデックス（101文字）のみで行う

2. **同一音の扱い**
   - 「づ」「ぢ」「を」は独立したクラスとして存在しない
   - これらの文字は入力時の判定でのみ考慮される

3. **類似文字の調整**
   - 類似文字ペアは実際のモデルの誤認識パターンに基づいて定義
   - 必要に応じて調整可能

## パフォーマンス指標

- **Top-1精度**: 約82.4%
- **Top-3精度**: 約89.3%
- **Top-3+類似調整**: 約92.3%
- **処理時間**: 平均200-300ms（デバイスによる）

## 実装ファイル

- **メイン実装**: `/src/services/aiService.ts`
- **文字マッピング**: `CLASS_LABELS` 配列（497行目〜）
- **判定ロジック**: `processProbabilities` メソッド（564行目〜）
- **同一扱い定義**: `IDENTICAL_PAIRS` オブジェクト（514行目〜）
- **類似文字定義**: `SIMILAR_PAIRS` オブジェクト（525行目〜）