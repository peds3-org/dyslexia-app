import React, { useState, useEffect, useRef } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  Animated,
  Alert,
  ScrollView,
  SafeAreaView,
  Image,
  ImageBackground,
  Easing,
  Dimensions,
  Button,
} from 'react-native';
import { Audio } from 'expo-av';
import { useRouter } from 'expo-router';
import { supabase } from '@src/lib/supabase';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import { stageService } from '@src/services/stageService';
import * as FileSystem from 'expo-file-system';
import { StageType } from '@src/types/progress';
import AsyncStorage from '@react-native-async-storage/async-storage';
import aiService from '@src/services/aiService';
import { Platform } from 'react-native';

const SCREEN_WIDTH = Dimensions.get('window').width;

const INTRO_PAGES = [
  {
    title: 'ã“ã‚“ã«ã¡ã¯ï¼',
    message: 'ã¼ãã¯ ã«ã‚“ã˜ã‚ƒã®\nã—ã‚‡ã†ã­ã‚“ã§ã™ï¼\nã„ã£ã—ã‚‡ã« ãŸã®ã—ã ã¹ã‚“ãã‚‡ã†ã—ã‚ˆã†ã­ï¼',
    backgroundColor: '#FFE0B2',
    image: require('@assets/temp/ninja_syuriken_man.png'),
  },
  {
    title: 'ãªã«ã‚’ã™ã‚‹ã®ï¼Ÿ',
    message: 'ãŒã‚ã‚“ã« ã§ã¦ãã‚‹ ã‚‚ã˜ã‚’\nã‚ˆã‚“ã§ã¿ã¦ã­ï¼\nãã¿ã® ã‚ˆã¿ã‹ãŸã‚’ ãã‹ã›ã¦ã­ï¼',
    backgroundColor: '#B2DFDB',
    image: require('@assets/temp/ninja_syuriken_man.png'),
  },
  {
    title: 'ã©ã†ã‚„ã‚‹ã®ï¼Ÿ',
    message: 'ã‚‚ã˜ãŒ ã§ã¦ããŸã‚‰\nãŠãŠããª ã“ãˆã§ ã‚ˆã‚“ã§ã­ï¼\nã‚ˆã¿ãŠã‚ã£ãŸã‚‰ ã—ãŸã® ãƒœã‚¿ãƒ³ã‚’\nã‚¿ãƒƒãƒ—ã—ã¦ã­ï¼',
    backgroundColor: '#F8BBD0',
    image: require('@assets/temp/ninja_syuriken_man.png'),
  },
  {
    title: 'ã ã„ã˜ã‚‡ã†ã¶ï¼',
    message: 'ã¯ã‚„ã ã‚ˆã‚ãªãã¦ã‚‚\nã ã„ã˜ã‚‡ã†ã¶ï¼\nã‚†ã£ãã‚Š ãŸã®ã—ã\nãŒã‚“ã°ã‚ã†ã­ï¼',
    backgroundColor: '#C5CAE9',
    image: require('@assets/temp/elder-worried.png'),
  },
  {
    title: 'ãƒ¬ãƒƒãƒ„ã‚´ãƒ¼ï¼ ğŸŒŸ',
    message: 'ã‚ãã‚ã ãƒ‰ã‚­ãƒ‰ã‚­ï¼\nãã¿ã® ã¡ã‹ã‚‰ã‚’ ã¿ã›ã¦ã­ï¼\nã„ã£ã—ã‚‡ã« ãŸã®ã—ã‚‚ã†ï¼ ğŸ‰',
    backgroundColor: '#FFD54F',
    image: require('@assets/temp/ninja_syuriken_man.png'),
  },
];

// å…¨ã¦ã®æ‹—éŸ³ã®ãƒªã‚¹ãƒˆ
const YOON_LIST = [
  'ãã‚ƒ',
  'ãã‚…',
  'ãã‚‡',
  'ã—ã‚ƒ',
  'ã—ã‚…',
  'ã—ã‚‡',
  'ã¡ã‚ƒ',
  'ã¡ã‚…',
  'ã¡ã‚‡',
  'ã«ã‚ƒ',
  'ã«ã‚…',
  'ã«ã‚‡',
  'ã²ã‚ƒ',
  'ã²ã‚…',
  'ã²ã‚‡',
  'ã¿ã‚ƒ',
  'ã¿ã‚…',
  'ã¿ã‚‡',
  'ã‚Šã‚ƒ',
  'ã‚Šã‚…',
  'ã‚Šã‚‡',
  'ãã‚ƒ',
  'ãã‚…',
  'ãã‚‡',
  'ã˜ã‚ƒ',
  'ã˜ã‚…',
  'ã˜ã‚‡',
  'ã³ã‚ƒ',
  'ã³ã‚…',
  'ã³ã‚‡',
  'ã´ã‚ƒ',
  'ã´ã‚…',
  'ã´ã‚‡',
];

// æ¿éŸ³ãƒ»åŠæ¿éŸ³ã®ãƒªã‚¹ãƒˆ
const DAKUON_LIST = [
  'ãŒ',
  'ã',
  'ã',
  'ã’',
  'ã”',
  'ã–',
  'ã˜',
  'ãš',
  'ãœ',
  'ã',
  'ã ',
  'ã¢',
  'ã¥',
  'ã§',
  'ã©',
  'ã°',
  'ã³',
  'ã¶',
  'ã¹',
  'ã¼',
  'ã±',
  'ã´',
  'ã·',
  'ãº',
  'ã½',
];

// æ¸…éŸ³ã®ãƒªã‚¹ãƒˆï¼ˆæ‹—éŸ³ã¨æ¿éŸ³ãƒ»åŠæ¿éŸ³ä»¥å¤–ã®åŸºæœ¬çš„ãªã²ã‚‰ãŒãªï¼‰
const SEION_LIST = [
  'ã‚',
  'ã„',
  'ã†',
  'ãˆ',
  'ãŠ',
  'ã‹',
  'ã',
  'ã',
  'ã‘',
  'ã“',
  'ã•',
  'ã—',
  'ã™',
  'ã›',
  'ã',
  'ãŸ',
  'ã¡',
  'ã¤',
  'ã¦',
  'ã¨',
  'ãª',
  'ã«',
  'ã¬',
  'ã­',
  'ã®',
  'ã¯',
  'ã²',
  'ãµ',
  'ã¸',
  'ã»',
  'ã¾',
  'ã¿',
  'ã‚€',
  'ã‚',
  'ã‚‚',
  'ã‚„',
  'ã‚†',
  'ã‚ˆ',
  'ã‚‰',
  'ã‚Š',
  'ã‚‹',
  'ã‚Œ',
  'ã‚',
  'ã‚',
  'ã‚’',
  'ã‚“',
];

const IntroPage = ({ page, index }: { page: (typeof INTRO_PAGES)[0]; index: number }) => {
  const bounceAnim = useRef(new Animated.Value(0)).current;
  const scaleAnim = useRef(new Animated.Value(1)).current;
  const rotateAnim = useRef(new Animated.Value(0)).current;

  useEffect(() => {
    // ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒã‚¦ãƒ³ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    Animated.loop(
      Animated.sequence([
        Animated.timing(bounceAnim, {
          toValue: -10,
          duration: 800,
          easing: Easing.inOut(Easing.quad),
          useNativeDriver: true,
        }),
        Animated.timing(bounceAnim, {
          toValue: 0,
          duration: 800,
          easing: Easing.inOut(Easing.quad),
          useNativeDriver: true,
        }),
      ])
    ).start();

    // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã®å ´åˆã€ç‰¹åˆ¥ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    if (index === INTRO_PAGES.length - 1) {
      Animated.loop(
        Animated.sequence([
          Animated.timing(scaleAnim, {
            toValue: 1.1,
            duration: 1000,
            useNativeDriver: true,
          }),
          Animated.timing(scaleAnim, {
            toValue: 1,
            duration: 1000,
            useNativeDriver: true,
          }),
        ])
      ).start();

      Animated.loop(
        Animated.timing(rotateAnim, {
          toValue: 1,
          duration: 3000,
          easing: Easing.linear,
          useNativeDriver: true,
        })
      ).start();
    }
  }, []);

  const isLastPage = index === INTRO_PAGES.length - 1;

  return (
    <View
      style={{
        width: SCREEN_WIDTH,
        flex: 1,
        alignItems: 'center',
        justifyContent: 'center',
        backgroundColor: page.backgroundColor,
      }}>
      <View
        style={{
          width: '90%',
          height: '90%',
          alignItems: 'center',
          justifyContent: 'space-between',
          paddingVertical: 20,
        }}>
        <Animated.View
          style={{
            backgroundColor: '#FFFFFF',
            borderRadius: 25,
            paddingHorizontal: 30,
            paddingVertical: 15,
            borderWidth: 4,
            borderColor: isLastPage ? '#FF6B6B' : '#FFE500',
            shadowColor: '#000',
            shadowOffset: { width: 0, height: 2 },
            shadowOpacity: 0.25,
            shadowRadius: 3.84,
            elevation: 5,
            transform: [
              { translateY: bounceAnim },
              { scale: isLastPage ? scaleAnim : 1 },
            ],
          }}>
          <Text
            style={{
              fontSize: isLastPage ? 36 : 32,
              fontFamily: 'Zen-B',
              color: isLastPage ? '#FF6B6B' : '#FF5B79',
              textAlign: 'center',
            }}>
            {page.title}
          </Text>
        </Animated.View>

        <Animated.View
          style={{
            width: '80%',
            height: '40%',
            justifyContent: 'center',
            alignItems: 'center',
            transform: isLastPage ? [
              {
                rotate: rotateAnim.interpolate({
                  inputRange: [0, 1],
                  outputRange: ['0deg', '360deg'],
                }),
              },
            ] : [],
          }}>
          <Image
            source={page.image}
            style={{
              width: '100%',
              height: '100%',
            }}
            resizeMode='contain'
          />
          {isLastPage && (
            <>
              <Text style={{
                position: 'absolute',
                fontSize: 40,
                top: -20,
                left: 20,
              }}>âœ¨</Text>
              <Text style={{
                position: 'absolute',
                fontSize: 40,
                bottom: -20,
                right: 20,
              }}>ğŸŒŸ</Text>
              <Text style={{
                position: 'absolute',
                fontSize: 40,
                top: 20,
                right: -10,
              }}>ğŸ’«</Text>
            </>
          )}
        </Animated.View>

        <View
          style={{
            backgroundColor: '#FFFFFF',
            borderRadius: 20,
            padding: 20,
            width: '90%',
            borderWidth: 3,
            borderColor: isLastPage ? '#FF6B6B' : '#FFE500',
            shadowColor: '#000',
            shadowOffset: { width: 0, height: 2 },
            shadowOpacity: 0.25,
            shadowRadius: 3.84,
            elevation: 5,
          }}>
          <Text
            style={{
              fontSize: isLastPage ? 26 : 24,
              fontFamily: 'Zen-B',
              color: '#333333',
              textAlign: 'center',
              lineHeight: isLastPage ? 40 : 36,
            }}>
            {page.message}
          </Text>
        </View>

        <View
          style={{
            flexDirection: 'row',
            justifyContent: 'center',
            alignItems: 'center',
            marginTop: 20,
          }}>
          {INTRO_PAGES.map((_, i) => (
            <Animated.View
              key={i}
              style={{
                width: i === index ? 16 : 12,
                height: i === index ? 16 : 12,
                borderRadius: i === index ? 8 : 6,
                marginHorizontal: 5,
                borderWidth: 2,
                borderColor: isLastPage ? '#FF6B6B' : '#FFE500',
                backgroundColor: i === index ? (isLastPage ? '#FF6B6B' : '#FF5B79') : '#FFFFFF',
                transform: i === index && isLastPage ? [{ scale: scaleAnim }] : [],
              }}
            />
          ))}
        </View>
      </View>
    </View>
  );
};

interface TestResult {
  yoon: string;
  time: number;
  aiResult?: {
    top3?: Array<{
      character: string;
      confidence: number;
    }>;
    isCorrect?: boolean;
    processingTime?: number;
  };
}

export default function InitialTest() {
  const router = useRouter();
  const [currentPage, setCurrentPage] = useState(0);
  const [showIntro, setShowIntro] = useState(true);
  const scrollViewRef = useRef<ScrollView>(null);
  const [recording, setRecording] = useState<Audio.Recording | null>(null);
  const [currentYoon, setCurrentYoon] = useState('');
  const [startTime, setStartTime] = useState<number | null>(null);
  const [remainingYoon, setRemainingYoon] = useState<string[]>([]);
  const [results, setResults] = useState<TestResult[]>([]);
  const [isRecording, setIsRecording] = useState(false);
  const [showResults, setShowResults] = useState(false);
  const [testLevel, setTestLevel] = useState<'beginner' | 'intermediate' | null>(null);
  const [isPaused, setIsPaused] = useState(false);
  const [showEncouragement, setShowEncouragement] = useState(false);
  const [currentEncouragementCount, setCurrentEncouragementCount] = useState(0);
  const fadeAnim = useRef(new Animated.Value(1)).current;
  const [isAIReady, setIsAIReady] = useState(false);
  const [isProcessingAI, setIsProcessingAI] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);
  const [isTransitioning, setIsTransitioning] = useState(false);

  const scaleAnim = useRef(new Animated.Value(1)).current;
  const speakingAnim = useRef(new Animated.Value(1)).current;
  const characterScale = useRef(new Animated.Value(1)).current;
  const elderFloatAnim = useRef(new Animated.Value(0)).current;
  const encouragementAnim = useRef(new Animated.Value(0)).current;

  // éŒ²éŸ³ã®çŠ¶æ…‹ã‚’è¿½è·¡ã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
  const [isRecordingUnloaded, setIsRecordingUnloaded] = useState(false);
  
  // 2.5ç§’ã‚¿ã‚¤ãƒãƒ¼ã®refã‚’è¿½åŠ 
  const recordingTimerRef = useRef<NodeJS.Timeout | null>(null);
  
  // æ®‹ã‚Šã®æ‹—éŸ³ã‚’refã§ã‚‚ç®¡ç†ï¼ˆã‚¿ã‚¤ãƒãƒ¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§æœ€æ–°ã®çŠ¶æ…‹ã‚’å‚ç…§ã™ã‚‹ãŸã‚ï¼‰
  const remainingYoonRef = useRef<string[]>([]);
  
  // éŒ²éŸ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚‚refã§ç®¡ç†
  const recordingRef = useRef<Audio.Recording | null>(null);
  const startTimeRef = useRef<number | null>(null);
  
  // ç¾åœ¨ã®æ‹—éŸ³ã‚‚refã§ç®¡ç†ï¼ˆã‚¿ã‚¤ãƒãƒ¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§æœ€æ–°ã®çŠ¶æ…‹ã‚’å‚ç…§ã™ã‚‹ãŸã‚ï¼‰
  const currentYoonRef = useRef<string>('');
  
  // çµæœã‚‚refã§ç®¡ç†ï¼ˆã‚¿ã‚¤ãƒãƒ¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§æœ€æ–°ã®çŠ¶æ…‹ã‚’å‚ç…§ã™ã‚‹ãŸã‚ï¼‰
  const resultsRef = useRef<TestResult[]>([]);
  
  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºç”¨ã®stateï¼ˆè¡¨ç¤ºã—ãªã„ã®ã§ä¸è¦ï¼‰
  // const [remainingTime, setRemainingTime] = useState<number>(2.5);
  // const countdownIntervalRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    // éŸ³å£°éŒ²éŸ³ã®æ¨©é™ã‚’å–å¾—ã¨éŒ²éŸ³é–‹å§‹
    const initializeRecording = async () => {
      await Audio.requestPermissionsAsync();
      
      // AIã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–
      console.log('AIã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–ä¸­...');
      const aiInitialized = await aiService.initialize();
      if (aiInitialized) {
        console.log('AIã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–æˆåŠŸ');
        setIsAIReady(true);
      } else {
        console.log('AIã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–å¤±æ•— - ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ');
        setIsAIReady(true); // ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ç¶šè¡Œ
      }
      
      // æ‹—éŸ³ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
      const shuffled = [...YOON_LIST].sort(() => Math.random() - 0.5);
      setRemainingYoon(shuffled);
      remainingYoonRef.current = shuffled;
      setCurrentYoon(shuffled[0]);
      currentYoonRef.current = shuffled[0];
      
      // åˆæœŸåŒ–å®Œäº†ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
      setIsInitialized(true);
    };

    initializeRecording();

    // å–‹ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
    Animated.loop(
      Animated.sequence([
        Animated.timing(speakingAnim, {
          toValue: 1.1,
          duration: 1000,
          useNativeDriver: true,
        }),
        Animated.timing(speakingAnim, {
          toValue: 1,
          duration: 1000,
          useNativeDriver: true,
        }),
      ])
    ).start();

    // é•·è€ã®ãµã‚ãµã‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    Animated.loop(
      Animated.sequence([
        Animated.timing(elderFloatAnim, {
          toValue: 1,
          duration: 2000,
          easing: Easing.inOut(Easing.sin),
          useNativeDriver: true,
        }),
        Animated.timing(elderFloatAnim, {
          toValue: 0,
          duration: 2000,
          easing: Easing.inOut(Easing.sin),
          useNativeDriver: true,
        }),
      ])
    ).start();

    return () => {
      // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆæ™‚ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦éŒ²éŸ³ã‚’åœæ­¢
      if (recordingTimerRef.current) {
        clearTimeout(recordingTimerRef.current);
        recordingTimerRef.current = null;
      }
      if (recordingRef.current) {
        recordingRef.current.stopAndUnloadAsync().catch(() => {
          // ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
        });
      }
    };
  }, []);

  // showIntroãŒfalseã«ãªã£ãŸã‚‰éŒ²éŸ³ã‚’é–‹å§‹
  useEffect(() => {
    console.log('useEffect triggered:', {
      showIntro,
      showResults,
      isInitialized,
      remainingYoonLength: remainingYoonRef.current.length,
      currentYoon: currentYoonRef.current
    });
    
    if (!showIntro && !showResults && isInitialized && remainingYoonRef.current.length > 0) {
      // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ç”»é¢é·ç§»ã‚’å®Œäº†ã•ã›ã‚‹
      const timer = setTimeout(() => {
        console.log('åˆå›éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã™', {
          currentYoon: currentYoonRef.current,
          remainingYoonLength: remainingYoonRef.current.length
        });
        startRecording();
      }, 500);
      
      return () => clearTimeout(timer);
    }
  }, [showIntro, showResults, isInitialized]);

  const startRecording = async () => {
    console.log('startRecordingé–‹å§‹', {
      isRecording,
      hasRecording: !!recording,
      currentYoon: currentYoonRef.current,
      remainingYoonLength: remainingYoonRef.current.length,
      isTransitioning
    });
    
    try {
      // æ—¢ã«éŒ²éŸ³ä¸­ã®å ´åˆã¯æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
      if (isRecording) {
        console.log('æ—¢ã«éŒ²éŸ³ä¸­ã®ãŸã‚ã€æ–°ã—ã„éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã›ã‚“');
        return;
      }
      
      // é·ç§»ä¸­ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆå¿µã®ãŸã‚ï¼‰
      setIsTransitioning(false);

      // æ—¢å­˜ã®éŒ²éŸ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      if (recordingRef.current) {
        try {
          const status = await recordingRef.current.getStatusAsync();
          if (status.isRecording) {
            await recordingRef.current.stopAndUnloadAsync();
          }
        } catch (e) {
          console.log('æ—¢å­˜ã®éŒ²éŸ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­ã®ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ï¼‰:', e);
        }
        setRecording(null);
        recordingRef.current = null;
        
        // å°‘ã—å¾…æ©Ÿã—ã¦ã‹ã‚‰æ–°ã—ã„éŒ²éŸ³ã‚’é–‹å§‹
        await new Promise(resolve => setTimeout(resolve, 200));
      }
      
      // éŒ²éŸ³é–‹å§‹å‰ã«å¿…ãšãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
      setIsRecordingUnloaded(false);

      await Audio.setAudioModeAsync({
        allowsRecordingIOS: true,
        playsInSilentModeIOS: true,
      });

      // voiceServiceã¨åŒã˜WAVéŒ²éŸ³è¨­å®šã‚’ä½¿ç”¨
      const recordingOptions: Audio.RecordingOptions = {
        android: {
          extension: '.wav',
          outputFormat: Audio.AndroidOutputFormat.DEFAULT,
          audioEncoder: Audio.AndroidAudioEncoder.DEFAULT,
          sampleRate: 16000,
          numberOfChannels: 1,
          bitRate: 256000,
        },
        ios: {
          extension: '.wav',
          audioQuality: Audio.IOSAudioQuality.HIGH,
          sampleRate: 16000,
          numberOfChannels: 1,
          bitRate: 256000,
          linearPCMBitDepth: 16,
          linearPCMIsBigEndian: false,
          linearPCMIsFloat: false,
        },
        web: {
          mimeType: 'audio/wav',
          bitsPerSecond: 256000,
        },
      };

      const { recording } = await Audio.Recording.createAsync(recordingOptions);

      console.log('éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã—ãŸ:', currentYoonRef.current);
      
      setRecording(recording);
      recordingRef.current = recording;
      setIsRecording(true);
      const now = Date.now();
      setStartTime(now);
      startTimeRef.current = now;

      // 2.5ç§’å¾Œã«è‡ªå‹•çš„ã«éŒ²éŸ³ã‚’åœæ­¢ã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®šï¼ˆè¡¨ç¤ºã¯ã—ãªã„ï¼‰
      recordingTimerRef.current = setTimeout(() => {
        console.log('2.5ç§’çµŒé - ã‚¿ã‚¤ãƒãƒ¼å‡¦ç†é–‹å§‹');
        // ã‚¿ã‚¤ãƒãƒ¼å†…ã§ç›´æ¥æ¬¡ã®å‡¦ç†ã‚’å®Ÿè¡Œ
        handleTimeoutAndMoveNext();
      }, 2500);

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      Animated.sequence([
        Animated.timing(scaleAnim, {
          toValue: 1.1,
          duration: 100,
          useNativeDriver: true,
        }),
        Animated.timing(scaleAnim, {
          toValue: 1,
          duration: 100,
          useNativeDriver: true,
        }),
      ]).start();
    } catch (err) {
      console.error('éŒ²éŸ³é–‹å§‹ã‚¨ãƒ©ãƒ¼:', err);
      Alert.alert('ã‚¨ãƒ©ãƒ¼', 'éŒ²éŸ³ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
    }
  };

  const showEncouragementPopover = () => {
    // ç¾åœ¨å®Œäº†ã—ãŸå•é¡Œæ•°ã‚’è¨ˆç®—
    const completedQuestions = YOON_LIST.length - remainingYoon.length;
    // 10ã®å€æ•°ã®å•é¡Œæ•°ã‚’è¨­å®š
    setCurrentEncouragementCount(completedQuestions);

    Animated.spring(encouragementAnim, {
      toValue: 1,
      useNativeDriver: true,
      damping: 15,
      stiffness: 150,
    }).start();
    setShowEncouragement(true);
  };

  const hideEncouragementPopover = () => {
    Animated.timing(encouragementAnim, {
      toValue: 0,
      duration: 200,
      useNativeDriver: true,
    }).start(() => {
      setShowEncouragement(false);
    });
  };

  // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®å‡¦ç†ï¼ˆç¢ºå®Ÿã«æ¬¡ã®æ–‡å­—ã¸é€²ã‚€ï¼‰
  const handleTimeoutAndMoveNext = async () => {
    console.log('handleTimeoutAndMoveNexté–‹å§‹');
    
    // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (recordingTimerRef.current) {
      clearTimeout(recordingTimerRef.current);
      recordingTimerRef.current = null;
    }
    
    // éŒ²éŸ³ãŒã‚ã‚Œã°åœæ­¢
    if (recordingRef.current) {
      try {
        const status = await recordingRef.current.getStatusAsync();
        if (status.isRecording) {
          await recordingRef.current.stopAndUnloadAsync();
        }
      } catch (e) {
        console.log('éŒ²éŸ³åœæ­¢ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ï¼‰:', e);
      }
    }
    
    // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    setIsRecording(false);
    setRecording(null);
    recordingRef.current = null;
    setStartTime(null);
    startTimeRef.current = null;
    setIsRecordingUnloaded(false);
    
    // ãƒ€ãƒŸãƒ¼ã®çµæœã‚’ä¿å­˜ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ã—ã¦ï¼‰
    const testResult: TestResult = { 
      yoon: currentYoonRef.current, 
      time: 2.5, // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“
      aiResult: undefined // AIã¯ä½¿ç”¨ã—ãªã„
    };
    
    const newResults = [...resultsRef.current, testResult];
    setResults(newResults);
    resultsRef.current = newResults;
    
    // æ¬¡ã®æ–‡å­—ã¸ç¢ºå®Ÿã«é€²ã‚€
    const currentRemainingYoon = remainingYoonRef.current;
    const newRemaining = currentRemainingYoon.slice(1);
    
    console.log('æ¬¡ã®æ–‡å­—ã¸é·ç§»ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰:', {
      ç¾åœ¨ã®æ–‡å­—: currentYoonRef.current,
      æ¬¡ã®æ–‡å­—: newRemaining[0],
      æ®‹ã‚Š: newRemaining.length
    });
    
    if (newRemaining.length > 0) {
      // 10å•ã”ã¨ã«åŠ±ã¾ã—ã‚’è¡¨ç¤º
      const questionNumber = YOON_LIST.length - newRemaining.length;
      if (questionNumber > 0 && questionNumber % 10 === 0) {
        // åŠ±ã¾ã—è¡¨ç¤ºã®å ´åˆã‚‚æ®‹ã‚Šã®æ‹—éŸ³ã‚’æ›´æ–°
        setRemainingYoon(newRemaining);
        remainingYoonRef.current = newRemaining;
        setCurrentYoon(newRemaining[0]);
        currentYoonRef.current = newRemaining[0];
        encouragementAnim.setValue(0);
        showEncouragementPopover();
      } else {
        // ç›´æ¥çŠ¶æ…‹ã‚’æ›´æ–°
        setRemainingYoon(newRemaining);
        remainingYoonRef.current = newRemaining;
        setCurrentYoon(newRemaining[0]);
        currentYoonRef.current = newRemaining[0];
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®éŒ²éŸ³ã‚’é–‹å§‹
        setIsTransitioning(true);
        setTimeout(() => {
          console.log('æ¬¡ã®éŒ²éŸ³ã‚’é–‹å§‹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œï¼‰');
          setIsTransitioning(false);
          startRecording();
        }, 500);
      }
    } else {
      // ãƒ†ã‚¹ãƒˆå®Œäº†
      await saveResults();
    }
  };

  const handleEncouragementContinue = () => {
    hideEncouragementPopover();
    // æ—¢ã«æ¬¡ã®æ–‡å­—ã¯è¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ã€éŒ²éŸ³ã‚’é–‹å§‹ã™ã‚‹ã ã‘
    console.log('åŠ±ã¾ã—å¾Œã®éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã™:', currentYoonRef.current);
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éŒ²éŸ³é–‹å§‹
    setTimeout(() => {
      setIsTransitioning(false);
      startRecording();
    }, 300);
  };

  const stopRecording = async () => {
    // æœ€åˆã®å•é¡Œã§éŒ²éŸ³ã‚’é–‹å§‹ã™ã‚‹å ´åˆ
    if (!isRecording && !recording && results.length === 0) {
      console.log('æœ€åˆã®éŒ²éŸ³ã‚’é–‹å§‹');
      startRecording();
      return;
    }
    
    // éŒ²éŸ³ãŒãªã„ã€ã¾ãŸã¯æ—¢ã«å‡¦ç†ä¸­ã®å ´åˆã¯ãƒªã‚¿ãƒ¼ãƒ³
    if (!recording || !startTime) {
      console.log('stopRecordingæ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ï¼ˆéŒ²éŸ³ãªã—ï¼‰:', { 
        hasRecording: !!recording, 
        hasStartTime: !!startTime,
        isRecording,
        currentYoon: currentYoonRef.current,
        resultsLength: results.length
      });
      
      // é·ç§»ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
      if (isTransitioning) {
        console.log('é·ç§»ä¸­ã®ãŸã‚ã€ã‚¿ãƒƒãƒ—ã‚’ç„¡è¦–');
        return;
      }
      
      // éŒ²éŸ³ãŒã¾ã é–‹å§‹ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ã—ã¦å‡¦ç†
      if (!isRecording && currentYoonRef.current && remainingYoonRef.current.length > 0) {
        console.log('éŒ²éŸ³é–‹å§‹å‰ã®ã‚¿ãƒƒãƒ— - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ã—ã¦å‡¦ç†');
        handleTimeoutAndMoveNext();
      }
      return;
    }

    // æ—¢ã«å‡¦ç†ä¸­ã®å ´åˆã‚‚ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆãŸã ã—ãƒ•ãƒ©ã‚°ã¯å¾Œã§è¨­å®šï¼‰
    if (isRecordingUnloaded) {
      console.log('stopRecordingæ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ï¼ˆæ—¢ã«å‡¦ç†ä¸­ï¼‰');
      return;
    }

    // ã™ãã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦é‡è¤‡å‡¦ç†ã‚’é˜²ã
    setIsRecordingUnloaded(true);

    // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (recordingTimerRef.current) {
      clearTimeout(recordingTimerRef.current);
      recordingTimerRef.current = null;
    }

    try {
      // æ™‚é–“è¨ˆæ¸¬ã‚’å³åº§ã«åœæ­¢ï¼ˆAIå‡¦ç†æ™‚é–“ã‚’å«ã‚ãªã„ï¼‰
      const endTime = Date.now();
      const duration = (endTime - startTime) / 1000;

      // æœ€å°æ™‚é–“ã‚’0.5ç§’ã«åˆ¶é™
      const adjustedDuration = Math.max(duration, 0.5);

      // éŒ²éŸ³ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰åœæ­¢
      const recordingStatus = await recording.getStatusAsync();
      if (recordingStatus.isRecording) {
        await recording.stopAndUnloadAsync();
      } else {
        console.log('éŒ²éŸ³ã¯æ—¢ã«åœæ­¢ã—ã¦ã„ã¾ã™');
        // æ—¢ã«åœæ­¢ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ã¿è©¦è¡Œ
        try {
          await recording._cleanupForUnloadedRecorder();
        } catch (e) {
          // ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
          console.log('ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—');
        }
      }
      
      // éŒ²éŸ³ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®URIã‚’å–å¾—
      const audioUri = recording.getURI();
      console.log(`éŒ²éŸ³å®Œäº†: ${audioUri}`);
      
      // éŒ²éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ‡ãƒãƒƒã‚°
      if (audioUri) {
        try {
          const fileInfo = await FileSystem.getInfoAsync(audioUri);
          console.log('éŒ²éŸ³ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:', fileInfo);
        } catch (e) {
          console.error('ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
      }
      
      // AIã§éŸ³å£°èªè­˜ã‚’å®Ÿè¡Œï¼ˆæ™‚é–“è¨ˆæ¸¬å¾Œã«å®Ÿè¡Œï¼‰
      let aiResult = undefined;
      if (isAIReady && !isProcessingAI && audioUri) {
        setIsProcessingAI(true);
        console.log(`AIéŸ³å£°èªè­˜é–‹å§‹: æœŸå¾…ã•ã‚Œã‚‹æ–‡å­— = ${currentYoonRef.current}, éŸ³å£°URI = ${audioUri}`);
        
        try {
          // AIã‚µãƒ¼ãƒ“ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’è¨­å®šï¼ˆnullã«è¨­å®šã—ã¦DBã¸ã®ä¿å­˜ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          aiService.setCurrentSessionId(null);
          
          // éŸ³å£°èªè­˜ã‚’å®Ÿè¡Œï¼ˆæœŸå¾…ã•ã‚Œã‚‹çµæœã¨éŒ²éŸ³URIã‚’æ¸¡ã™ï¼‰
          const classificationResult = await aiService.classifySpeech(currentYoonRef.current, 'beginner', audioUri);
          
          if (classificationResult) {
            console.log('AIèªè­˜çµæœ:', {
              character: classificationResult.character,
              confidence: classificationResult.confidence,
              isCorrect: classificationResult.isCorrect,
              top3: classificationResult.top3,
              processingTime: classificationResult.processingTimeMs
            });
            
            // Top-3çµæœã¨æ­£è§£åˆ¤å®šã‚’å‡¦ç†
            const CONFIDENCE_THRESHOLD = 0.75;
            const topPrediction = classificationResult.top3?.[0];
            const isHighConfidence = topPrediction ? topPrediction.confidence >= CONFIDENCE_THRESHOLD : false;
            
            aiResult = {
              top3: classificationResult.top3 || [],
              isCorrect: classificationResult.isCorrect !== undefined ? 
                (classificationResult.isCorrect && isHighConfidence) : false,
              processingTime: classificationResult.processingTimeMs
            };
            
            if (classificationResult.top3) {
              console.log(`AIåˆ¤å®šè©³ç´°: æœŸå¾…=${currentYoonRef.current}`);
              console.log('Top-3äºˆæ¸¬:', classificationResult.top3.map((pred, i) => 
                `${i+1}ä½: ${pred.character} (${(pred.confidence * 100).toFixed(1)}%)`
              ).join(', '));
              console.log(`æ­£è§£åˆ¤å®š: ${aiResult.isCorrect ? 'â—‹' : 'Ã—'} (é–¾å€¤: ${CONFIDENCE_THRESHOLD * 100}%)`);
            }
          }
        } catch (aiError) {
          console.error('AIèªè­˜ã‚¨ãƒ©ãƒ¼:', aiError);
          // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ†ã‚¹ãƒˆã¯ç¶šè¡Œ
        } finally {
          setIsProcessingAI(false);
        }
      }

      // çµæœã‚’ä¿å­˜ï¼ˆAIçµæœã‚’å«ã‚€ï¼‰
      const testResult: TestResult = { 
        yoon: currentYoonRef.current, 
        time: adjustedDuration, // AIå‡¦ç†æ™‚é–“ã‚’å«ã¾ãªã„ç´”ç²‹ãªå¿œç­”æ™‚é–“
        aiResult
      };
      
      const newResults = [...resultsRef.current, testResult];
      setResults(newResults);
      resultsRef.current = newResults;

      // çŠ¶æ…‹ã‚’å³åº§ã«ãƒªã‚»ãƒƒãƒˆï¼ˆé‡è¦ï¼šæ¬¡ã®éŒ²éŸ³ã®ãŸã‚ã«å¿…è¦ï¼‰
      console.log('éŒ²éŸ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ');
      setIsRecording(false);
      setRecording(null);
      recordingRef.current = null;
      setStartTime(null);
      startTimeRef.current = null;
      setIsRecordingUnloaded(false);
      setIsTransitioning(true); // é·ç§»ä¸­ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ

      // æ¬¡ã®æ‹—éŸ³ã‚’è¨­å®šï¼ˆrefã‹ã‚‰æœ€æ–°ã®çŠ¶æ…‹ã‚’å–å¾—ï¼‰
      const currentRemainingYoon = remainingYoonRef.current;
      const newRemaining = currentRemainingYoon.slice(1);

      console.log('æ¬¡ã®æ–‡å­—ã¸é·ç§»:', {
        ç¾åœ¨ã®æ–‡å­—: currentYoonRef.current,
        æ¬¡ã®æ–‡å­—: newRemaining[0],
        æ®‹ã‚Šæ–‡å­—æ•°: newRemaining.length
      });

      if (newRemaining.length > 0) {
        // 10å•ã”ã¨ã«åŠ±ã¾ã—ã‚’è¡¨ç¤º
        const questionNumber = YOON_LIST.length - newRemaining.length;
        if (questionNumber > 0 && questionNumber % 10 === 0) {
          // åŠ±ã¾ã—è¡¨ç¤ºã®å ´åˆã‚‚æ®‹ã‚Šã®æ‹—éŸ³ã‚’æ›´æ–°
          setRemainingYoon(newRemaining);
          remainingYoonRef.current = newRemaining;
          setCurrentYoon(newRemaining[0]);
          currentYoonRef.current = newRemaining[0];
          encouragementAnim.setValue(0); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
          showEncouragementPopover();
        } else {
          // çŠ¶æ…‹ã‚’æ›´æ–°
          setRemainingYoon(newRemaining);
          remainingYoonRef.current = newRemaining;
          setCurrentYoon(newRemaining[0]);
          currentYoonRef.current = newRemaining[0];
          
          // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ç¢ºå®Ÿã«å‰ã®éŒ²éŸ³ãŒå®Œäº†ã—ã¦ã‹ã‚‰æ¬¡ã‚’é–‹å§‹
          setTimeout(() => {
            console.log('æ¬¡ã®éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã™:', newRemaining[0]);
            setIsTransitioning(false); // é·ç§»ä¸­ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
            startRecording();
          }, 500);
        }
      } else {
        // ãƒ†ã‚¹ãƒˆå®Œäº†
        setIsTransitioning(false);
        await saveResults();
      }
    } catch (err) {
      console.error('éŒ²éŸ³åœæ­¢ã‚¨ãƒ©ãƒ¼:', err);
      // "already unloaded"ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã™ã‚‹ï¼ˆæ­£å¸¸ãªçŠ¶æ…‹ï¼‰
      if (err instanceof Error && err.message.includes('already been unloaded')) {
        console.log('éŒ²éŸ³ã¯æ—¢ã«åœæ­¢ã•ã‚Œã¦ã„ã¾ã™ï¼ˆæ­£å¸¸ï¼‰');
        // ã‚¨ãƒ©ãƒ¼ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã—ãªã„
      } else {
        Alert.alert('ã‚¨ãƒ©ãƒ¼', 'éŒ²éŸ³ã‚’åœæ­¢ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
      }
    } finally {
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®ã¿çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      if (isRecording || isTransitioning) {
        console.log('finally: ã‚¨ãƒ©ãƒ¼ã®ãŸã‚éŒ²éŸ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ');
        setIsRecording(false);
        setRecording(null);
        recordingRef.current = null;
        setStartTime(null);
        startTimeRef.current = null;
        setIsRecordingUnloaded(false);
        setIsTransitioning(false); // é·ç§»ä¸­ãƒ•ãƒ©ã‚°ã‚‚ãƒªã‚»ãƒƒãƒˆ
      }
    }
  };

  const saveResults = async () => {
    try {
      const currentTime = Date.now();
      const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
      if (sessionError) throw sessionError;

      if (!sessionData.session?.user?.id) {
        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“');
      }

      const userId = sessionData.session.user.id;

      // ä»•æ§˜æ›¸ã«åŸºã¥ãæ­£ç­”ç‡ã®è¨ˆç®—
      // AIèªè­˜çµæœãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã„å ´åˆã¯æ™‚é–“ãƒ™ãƒ¼ã‚¹ã§åˆ¤å®š
      const correctAnswers = results.filter((result) => {
        if (result.aiResult && result.aiResult.isCorrect !== undefined) {
          // AIèªè­˜çµæœã‚’å„ªå…ˆ
          return result.aiResult.isCorrect;
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: 2.5ç§’ä»¥å†…ã‚’æ­£è§£ã¨ã™ã‚‹
          return result.time <= 2.5;
        }
      });
      const correctRate = correctAnswers.length / results.length;
      
      // AIèªè­˜ã®çµ±è¨ˆæƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
      const aiResults = results.filter(r => r.aiResult);
      console.log('AIèªè­˜çµ±è¨ˆ:', {
        ç·å•é¡Œæ•°: results.length,
        AIèªè­˜å®Ÿè¡Œæ•°: aiResults.length,
        AIæ­£è§£æ•°: aiResults.filter(r => r.aiResult?.isCorrect).length,
        å¹³å‡ä¿¡é ¼åº¦: aiResults.reduce((sum, r) => sum + (r.aiResult?.confidence || 0), 0) / (aiResults.length || 1)
      });

      // å¹³å‡å›ç­”æ™‚é–“ã‚’è¨ˆç®—
      const averageTime = results.reduce((sum, result) => sum + result.time, 0) / results.length;

      // æ¸…éŸ³ãƒ»æ¿éŸ³ãƒ»æ‹—éŸ³ã”ã¨ã®å¹³å‡æ™‚é–“ã‚’è¨ˆç®—
      const seionResults = results.filter((r) => SEION_LIST.includes(r.yoon));
      const dakuonResults = results.filter((r) => DAKUON_LIST.includes(r.yoon));
      const yoonResults = results.filter((r) => YOON_LIST.includes(r.yoon));

      const seionAvg = seionResults.length > 0 ? seionResults.reduce((sum, r) => sum + r.time, 0) / seionResults.length : 0;
      const dakuonAvg = dakuonResults.length > 0 ? dakuonResults.reduce((sum, r) => sum + r.time, 0) / dakuonResults.length : 0;
      const yoonAvg = yoonResults.length > 0 ? yoonResults.reduce((sum, r) => sum + r.time, 0) / yoonResults.length : 0;

      // çµæœã«åŸºã¥ã„ã¦ãƒ¬ãƒ™ãƒ«åˆ¤å®šï¼ˆæ·»ä»˜ç”»åƒã®ä»•æ§˜ã«å¾“ã£ã¦ï¼‰
      let determinedLevel;

      if (correctRate >= 1 / 3) {
        // æ­£ç­”ç‡ãŒ1/3ä»¥ä¸Šã®å ´åˆã€ä¸­ç´šã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
        determinedLevel = 'intermediate';
        setTestLevel('intermediate');
      } else {
        // æ­£ç­”ç‡ãŒ1/3æœªæº€ã®å ´åˆã€åˆç´šã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
        determinedLevel = 'beginner';
        setTestLevel('beginner');
      }

      // çµæœã‚’ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      await AsyncStorage.setItem(
        'initialTestResults',
        JSON.stringify({
          results,
          correctRate,
          averageTime,
          seionAvg,
          dakuonAvg,
          yoonAvg,
          determinedLevel,
          timestamp: currentTime,
        })
      );

      // Supabaseã«ã‚‚çµæœã‚’ä¿å­˜
      const { error: insertError } = await supabase.from('user_test_results').insert({
        user_id: userId,
        results: JSON.stringify(results),
        correct_rate: correctRate,
        average_time: averageTime,
        seion_avg: seionAvg,
        dakuon_avg: dakuonAvg,
        yoon_avg: yoonAvg,
        determined_level: determinedLevel,
        created_at: new Date().toISOString(),
      });

      if (insertError) throw insertError;

      // initial_test_resultsãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
      const { error: updateError } = await supabase.from('initial_test_results').upsert({
        user_id: userId,
        is_completed: true,
        level: determinedLevel,
        completed_at: new Date().toISOString(),
        results: JSON.stringify(results),
      });

      if (updateError) {
        console.error('ãƒ†ã‚¹ãƒˆå®Œäº†çŠ¶æ…‹ã®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
        // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å‡ºã™ã ã‘ã§å‡¦ç†ã¯ç¶šè¡Œ
      } else {
        console.log('ãƒ†ã‚¹ãƒˆå®Œäº†çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ: is_completed=true, level=' + determinedLevel);
      }

      // user_profilesãƒ†ãƒ¼ãƒ–ãƒ«ã®character_levelã‚‚æ›´æ–°
      const { error: profileUpdateError } = await supabase
        .from('user_profiles')
        .update({
          character_level: determinedLevel,
        })
        .eq('user_id', userId);

      if (profileUpdateError) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ãƒ¬ãƒ™ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', profileUpdateError);
      } else {
        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ãƒ¬ãƒ™ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ: character_level=' + determinedLevel);
      }

      setShowResults(true);

      // ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ã¦åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¨­å®š
      await stageService.initializeStageForUser(userId, determinedLevel === 'beginner' ? StageType.BEGINNER : StageType.INTERMEDIATE);

      // ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯å‰Šé™¤ã—ãªã„ - ä»¥ä¸‹ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚ŒãŸå…ƒã®é·ç§»ã‚³ãƒ¼ãƒ‰
      // router.replace('/screens/intermediate');ã‚„/screens/beginnerã¸ã®é·ç§»ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    } catch (error) {
      console.error('é€²æ—ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      Alert.alert('ã‚¨ãƒ©ãƒ¼', 'é€²æ—ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };

  const ResultsScreen = () => {
    // AIèªè­˜çµæœã‚’è€ƒæ…®ã—ãŸæ­£è§£æ•°ã®è¨ˆç®—
    const correctCount = results.filter((r) => {
      if (r.aiResult && r.aiResult.isCorrect !== undefined) {
        return r.aiResult.isCorrect;
      }
      return r.time <= 2.5;
    }).length;
    const accuracy = (correctCount / YOON_LIST.length) * 100;

    // æ–‡å­—ã®ç¨®é¡ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
    const getCharacterType = (char: string) => {
      if (SEION_LIST.includes(char)) return 'ã›ã„ãŠã‚“';
      if (DAKUON_LIST.includes(char)) return 'ã ããŠã‚“';
      if (YOON_LIST.includes(char)) return 'ã‚ˆã†ãŠã‚“';
      return 'ãã®ä»–';
    };

    // çµæœã‚’åˆ†é¡ã™ã‚‹é–¢æ•°ï¼ˆæ™‚é–“ã¨æ–‡å­—ç¨®é¡ã‚’è€ƒæ…®ï¼‰
    const getTimeCategory = (time: number, char: string) => {
      const charType = getCharacterType(char);

      // æ·»ä»˜ç”»åƒã®ä»•æ§˜ã«åŸºã¥ã„ãŸæ™‚é–“åŒºåˆ†
      if (time <= 1.5) {
        // ä¸Šç´šï¼ˆè»½ç—‡ï¼‰
        return { message: 'ã¨ã¦ã‚‚ã˜ã‚‡ã†ãšï¼', color: '#4CAF50', bgColor: '#E8F5E9', level: 'ã˜ã‚‡ã†ãã‚…ã†' };
      } else if (time <= 2.0) {
        // ä¸­ç´š
        return { message: 'ã˜ã‚‡ã†ãšï¼', color: '#2196F3', bgColor: '#E3F2FD', level: 'ã¡ã‚…ã†ãã‚…ã†' };
      } else if (time <= 2.5) {
        // åˆç´šï¼ˆé‡ç—‡ï¼‰
        return { message: 'ãŒã‚“ã°ã£ãŸã­', color: '#FF9800', bgColor: '#FFF3E0', level: 'ã—ã‚‡ãã‚…ã†' };
      } else {
        // 2.5ç§’ä»¥ä¸Š
        return { message: 'ã‚‚ã†ã™ã“ã—ï¼', color: '#F44336', bgColor: '#FFEBEE', level: 'ã—ã‚‡ãã‚…ã†' };
      }
    };

    // 10å•ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹
    const groupedResults = results.reduce((acc, result, index) => {
      const groupIndex = Math.floor(index / 10);
      if (!acc[groupIndex]) {
        acc[groupIndex] = [];
      }
      acc[groupIndex].push(result);
      return acc;
    }, [] as TestResult[][]);

    return (
      <SafeAreaView style={{ flex: 1, backgroundColor: '#FFFFFF' }}>
        <ScrollView style={{ flex: 1, paddingHorizontal: 20 }}>
          <View style={{ alignItems: 'center', marginBottom: 30, marginTop: 20 }}>
            <Text style={{ fontFamily: 'font-mplus-bold', fontSize: 24, color: '#333', marginBottom: 10 }}>ã¦ã™ã¨ã‘ã£ã‹</Text>
            <Text style={{ fontFamily: 'font-mplus-bold', fontSize: 18, color: '#666', marginBottom: 5 }}>
              ãƒ¬ãƒ™ãƒ«: {testLevel === 'intermediate' ? 'ã¡ã‚…ã†ãã‚…ã†' : 'ã—ã‚‡ãã‚…ã†'}
            </Text>
          </View>

          {groupedResults.map((group, groupIndex) => (
            <View key={`group-${groupIndex}`} style={{ marginBottom: 30 }}>
              <Text style={{ fontFamily: 'font-mplus-bold', fontSize: 18, color: '#333', marginBottom: 10, textAlign: 'center' }}>
                ã ã„{groupIndex + 1}ã‚»ãƒƒãƒˆ
              </Text>
              <View style={{ marginBottom: 20 }}>
                {group.map((result, index) => {
                  const category = getTimeCategory(result.time, result.yoon);
                  return (
                    <View
                      key={index}
                      style={{
                        backgroundColor: category.bgColor,
                        padding: 15,
                        marginBottom: 8,
                        borderRadius: 12,
                        flexDirection: 'row',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                      }}>
                      <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}>
                        <Text
                          style={{
                            fontFamily: 'font-mplus-bold',
                            fontSize: 24,
                            marginRight: 15,
                            color: '#333',
                          }}>
                          {result.yoon}
                        </Text>
                        <View style={{ flex: 1 }}>
                          <Text
                            style={{
                              fontFamily: 'font-mplus',
                              fontSize: 16,
                              color: category.color,
                            }}>
                            {category.message}
                            {result.aiResult && (
                              <Text style={{ fontSize: 12 }}>
                                {result.aiResult.isCorrect ? ' âœ“' : ' âœ—'}
                              </Text>
                            )}
                          </Text>
                          <Text
                            style={{
                              fontFamily: 'font-mplus',
                              fontSize: 12,
                              color: '#666',
                            }}>
                            {getCharacterType(result.yoon)}ãƒ»{category.level}
                          </Text>
                          {result.aiResult?.top3 && result.aiResult.top3.length > 0 && (
                            <View style={{ marginTop: 2 }}>
                              <Text
                                style={{
                                  fontFamily: 'font-mplus',
                                  fontSize: 9,
                                  color: '#999',
                                }}>
                                AI Top-3:
                              </Text>
                              {result.aiResult.top3.slice(0, 3).map((pred, i) => (
                                <Text
                                  key={i}
                                  style={{
                                    fontFamily: 'font-mplus',
                                    fontSize: 8,
                                    color: i === 0 ? '#666' : '#999',
                                  }}>
                                  {i+1}. {pred.character} ({(pred.confidence * 100).toFixed(1)}%)
                                </Text>
                              ))}
                            </View>
                          )}
                        </View>
                      </View>
                      <Text
                        style={{
                          fontFamily: 'font-mplus',
                          fontSize: 14,
                          color: '#666',
                        }}>
                        {result.time.toFixed(2)}ç§’
                      </Text>
                    </View>
                  );
                })}
              </View>
            </View>
          ))}

          <TouchableOpacity
            onPress={async () => {
              try {
                // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
                const {
                  data: { session },
                } = await supabase.auth.getSession();
                if (!session?.user?.id) {
                  throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                }

                // ãƒ†ã‚¹ãƒˆãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦é©åˆ‡ãªç”»é¢ã«é·ç§»
                if (testLevel === 'intermediate') {
                  router.replace('/screens/intermediate');
                } else {
                  router.replace('/screens/beginner');
                }
              } catch (error) {
                console.error('ç”»é¢é·ç§»ã‚¨ãƒ©ãƒ¼:', error);
                Alert.alert('ã‚¨ãƒ©ãƒ¼', 'ã¤ãã® ãŒã‚ã‚“ã« ã™ã™ã‚ã¾ã›ã‚“ã§ã—ãŸ');
              }
            }}
            style={{
              backgroundColor: '#41644A',
              padding: 15,
              borderRadius: 8,
              alignItems: 'center',
              marginTop: 20,
              marginBottom: 30,
            }}>
            <Text style={{ color: '#FFF', fontFamily: 'font-mplus-bold', fontSize: 16 }}>ã¤ãã¸ã™ã™ã‚€</Text>
          </TouchableOpacity>
        </ScrollView>
      </SafeAreaView>
    );
  };

  // ä¸€æ™‚åœæ­¢å‡¦ç†
  const handlePause = async () => {
    try {
      // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
      if (recordingTimerRef.current) {
        clearTimeout(recordingTimerRef.current);
        recordingTimerRef.current = null;
      }
      
      if (recording && !isRecordingUnloaded) {
        await recording.stopAndUnloadAsync();
        setIsRecordingUnloaded(true);
        setIsRecording(false);
        setIsPaused(true);
        // ä¸€æ™‚åœæ­¢ã—ãŸæ™‚ç‚¹ã§recordingã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å†åˆ©ç”¨ã§ããªã„
      }
    } catch (error) {
      console.error('éŒ²éŸ³ã®ä¸€æ™‚åœæ­¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚çŠ¶æ…‹ã¯æ›´æ–°ã™ã‚‹
      setIsRecording(false);
      setIsPaused(true);
      setIsRecordingUnloaded(true);
    }
  };

  // éŒ²éŸ³å†é–‹å‡¦ç†
  const handleResume = async () => {
    try {
      // å¸¸ã«æ–°ã—ã„éŒ²éŸ³ã‚’é–‹å§‹ã™ã‚‹
      console.log('æ–°ã—ã„éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã™');
      await Audio.setAudioModeAsync({
        allowsRecordingIOS: true,
        playsInSilentModeIOS: true,
      });

      const { recording: newRecording } = await Audio.Recording.createAsync(Audio.RecordingOptionsPresets.HIGH_QUALITY);

      setRecording(newRecording);
      setIsRecordingUnloaded(false); // æ–°ã—ã„éŒ²éŸ³ãªã®ã§ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
      setIsRecording(true);
      setIsPaused(false);
      setStartTime(Date.now());

      // 2.5ç§’å¾Œã«è‡ªå‹•çš„ã«éŒ²éŸ³ã‚’åœæ­¢ã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®šï¼ˆè¡¨ç¤ºã¯ã—ãªã„ï¼‰
      recordingTimerRef.current = setTimeout(() => {
        console.log('2.5ç§’çµŒéã—ãŸãŸã‚ã€éŒ²éŸ³ã‚’è‡ªå‹•åœæ­¢ã—ã¾ã™');
        stopRecording();
      }, 2500);

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      Animated.sequence([
        Animated.timing(scaleAnim, {
          toValue: 1.1,
          duration: 100,
          useNativeDriver: true,
        }),
        Animated.timing(scaleAnim, {
          toValue: 1,
          duration: 100,
          useNativeDriver: true,
        }),
      ]).start();
    } catch (error) {
      console.error('éŒ²éŸ³ã®å†é–‹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    }
  };

  // éŒ²éŸ³å®Œå…¨åœæ­¢å‡¦ç†
  const handleStop = async () => {
    try {
      // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
      if (recordingTimerRef.current) {
        clearTimeout(recordingTimerRef.current);
        recordingTimerRef.current = null;
      }
      
      // éŒ²éŸ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ã€ã¾ã ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿åœæ­¢å‡¦ç†ã‚’å®Ÿè¡Œ
      if (recording && !isRecordingUnloaded) {
        try {
          await recording.stopAndUnloadAsync();
          setIsRecordingUnloaded(true);
        } catch (unloadError) {
          console.log('éŒ²éŸ³ã®åœæ­¢å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—:', String(unloadError));
          // ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã—ã¦å‡¦ç†ã‚’ç¶šè¡Œ
        }
      }

      // çŠ¶æ…‹ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ
      setIsRecording(false);
      setIsPaused(false);
      setRecording(null);
      setIsRecordingUnloaded(false); // æ¬¡ã®éŒ²éŸ³ã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ

      // ç¾åœ¨ã®æ–‡å­—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã®æ–‡å­—ã«é€²ã‚€
      const newRemaining = remainingYoon.slice(1);
      if (newRemaining.length > 0) {
        setRemainingYoon(newRemaining);
        remainingYoonRef.current = newRemaining;
        setCurrentYoon(newRemaining[0]);
        currentYoonRef.current = newRemaining[0];
        // æ¬¡ã®æ–‡å­—ã‚’è¡¨ç¤ºå¾Œã«éŒ²éŸ³ã‚’é–‹å§‹
        setTimeout(() => {
          startRecording();
        }, 500);
      } else {
        // ãƒ†ã‚¹ãƒˆå®Œäº†ã®å ´åˆ
        await saveResults();
      }
    } catch (error) {
      console.error('éŒ²éŸ³ã®åœæ­¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚æ¬¡ã®æ–‡å­—ã«é€²ã‚ã‚‹
      const newRemaining = remainingYoon.slice(1);
      if (newRemaining.length > 0) {
        setRemainingYoon(newRemaining);
        remainingYoonRef.current = newRemaining;
        setCurrentYoon(newRemaining[0]);
        currentYoonRef.current = newRemaining[0];
        setTimeout(() => {
          startRecording();
        }, 500);
      } else {
        await saveResults();
      }
    }
  };

  const handleScroll = (event: any) => {
    const offsetX = event.nativeEvent.contentOffset.x;
    const page = Math.round(offsetX / SCREEN_WIDTH);
    setCurrentPage(page);
  };

  const handleSkip = () => {
    setShowIntro(false);
  };

  const handleStart = () => {
    if (currentPage === INTRO_PAGES.length - 1) {
      setShowIntro(false);
    } else {
      scrollViewRef.current?.scrollTo({
        x: (currentPage + 1) * SCREEN_WIDTH,
        animated: true,
      });
    }
  };

  if (showIntro) {
    return (
      <SafeAreaView style={{ flex: 1 }}>
        <ScrollView
          ref={scrollViewRef}
          horizontal
          pagingEnabled
          showsHorizontalScrollIndicator={false}
          onScroll={handleScroll}
          scrollEventThrottle={16}>
          {INTRO_PAGES.map((page, index) => (
            <IntroPage key={index} page={page} index={index} />
          ))}
        </ScrollView>

        <View
          style={{
            flexDirection: 'row',
            justifyContent: 'space-between',
            alignItems: 'center',
            paddingHorizontal: 20,
            paddingBottom: 40,
            position: 'absolute',
            bottom: 0,
            left: 0,
            right: 0,
          }}>
          <TouchableOpacity
            style={{
              paddingVertical: 12,
              paddingHorizontal: 24,
              borderRadius: 25,
              backgroundColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2,
              borderColor: '#FFE500',
            }}
            onPress={handleSkip}>
            <Text
              style={{
                fontSize: 18,
                fontFamily: 'Zen-B',
                color: '#666666',
              }}>
              ã‚¹ã‚­ãƒƒãƒ—
            </Text>
          </TouchableOpacity>

          <TouchableOpacity
            style={{
              paddingVertical: 12,
              paddingHorizontal: 40,
              borderRadius: 25,
              backgroundColor: '#00C853',
              borderWidth: 3,
              borderColor: '#FFE500',
              shadowColor: '#000',
              shadowOffset: { width: 0, height: 2 },
              shadowOpacity: 0.25,
              shadowRadius: 3.84,
              elevation: 5,
            }}
            onPress={handleStart}>
            <Text
              style={{
                fontSize: 24,
                fontFamily: 'Zen-B',
                color: '#FFFFFF',
              }}>
              {currentPage === INTRO_PAGES.length - 1 ? 'ã¯ã˜ã‚ã‚‹' : 'ã¤ãã¸'}
            </Text>
          </TouchableOpacity>
        </View>
      </SafeAreaView>
    );
  }

  if (showResults) {
    return <ResultsScreen />;
  }

  return (
    <SafeAreaView style={{ flex: 1 }}>
      <ImageBackground
        source={require('../../assets/temp/doujou.png')}
        style={{
          flex: 1,
          width: '100%',
        }}
        resizeMode='cover'>
        <View
          style={{
            flex: 1,
            paddingHorizontal: 20,
            // backgroundColor: 'rgba(255, 255, 255, 0.85)',
          }}>
          {/* é•·è€ã®ã‚¤ãƒ©ã‚¹ãƒˆ */}
          <Animated.Image
            source={require('../../assets/temp/elder-worried.png')}
            style={{
              position: 'absolute',
              top: 20,
              left: 20,
              width: 60,
              height: 60,
              zIndex: 2,
              transform: [
                {
                  translateY: elderFloatAnim.interpolate({
                    inputRange: [0, 1],
                    outputRange: [0, -10],
                  }),
                },
              ],
              opacity: 0.9,
            }}
          />

          {/* é€²æ—è¡¨ç¤º */}
          <View
            style={{
              flexDirection: 'row',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginTop: 80, // é•·è€ã®ä¸‹ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«èª¿æ•´
              marginBottom: 20,
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              padding: 10,
              borderRadius: 15,
              shadowColor: '#000',
              shadowOffset: { width: 0, height: 2 },
              shadowOpacity: 0.1,
              shadowRadius: 4,
              elevation: 3,
            }}>
            <Text
              style={{
                fontFamily: 'font-mplus-bold',
                fontSize: 18,
                color: '#41644A',
                textShadowColor: 'rgba(255, 255, 255, 0.8)',
                textShadowOffset: { width: 1, height: 1 },
                textShadowRadius: 2,
              }}>
              ã®ã“ã‚Š: {remainingYoon.length} ã‚‚ã˜
            </Text>
            <TouchableOpacity onPress={handlePause}>
              <MaterialCommunityIcons name='close' size={24} color='#41644A' />
            </TouchableOpacity>
          </View>

          {/* ä¸€æ™‚åœæ­¢ä¸­ã®è¡¨ç¤º */}
          {isPaused && (
            <View
              style={{
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                justifyContent: 'center',
                alignItems: 'center',
                zIndex: 10,
                paddingHorizontal: 20,
              }}>
              <View
                style={{
                  backgroundColor: 'rgba(255, 255, 255, 0.9)',
                  padding: 30,
                  borderRadius: 25,
                  alignItems: 'center',
                  shadowColor: '#000',
                  shadowOffset: { width: 0, height: 4 },
                  shadowOpacity: 0.1,
                  shadowRadius: 8,
                  elevation: 5,
                }}>
                <Text
                  style={{
                    fontFamily: 'font-mplus-bold',
                    fontSize: 28,
                    color: '#41644A',
                    marginBottom: 30,
                    textAlign: 'center',
                  }}>
                  ã¦ã„ã—ã¡ã‚…ã†
                </Text>
                <View style={{ gap: 16, alignItems: 'center' }}>
                  <TouchableOpacity
                    onPress={handleResume}
                    style={{
                      backgroundColor: '#41644A',
                      paddingHorizontal: 30,
                      paddingVertical: 15,
                      borderRadius: 25,
                      flexDirection: 'row',
                      alignItems: 'center',
                      gap: 8,
                      minWidth: 200,
                      justifyContent: 'center',
                      shadowColor: '#000',
                      shadowOffset: { width: 0, height: 2 },
                      shadowOpacity: 0.2,
                      shadowRadius: 4,
                      elevation: 3,
                    }}>
                    <MaterialCommunityIcons name='play' size={24} color='#FFF' />
                    <Text style={{ color: '#FFF', fontFamily: 'font-mplus-bold', fontSize: 18 }}>ã•ã„ã‹ã„</Text>
                  </TouchableOpacity>

                  <TouchableOpacity
                    onPress={handleStop}
                    style={{
                      backgroundColor: '#E86A33',
                      paddingHorizontal: 30,
                      paddingVertical: 15,
                      borderRadius: 25,
                      flexDirection: 'row',
                      alignItems: 'center',
                      gap: 8,
                      minWidth: 200,
                      justifyContent: 'center',
                      shadowColor: '#000',
                      shadowOffset: { width: 0, height: 2 },
                      shadowOpacity: 0.2,
                      shadowRadius: 4,
                      elevation: 3,
                    }}>
                    <MaterialCommunityIcons name='close-circle' size={24} color='#FFF' />
                    <Text style={{ color: '#FFF', fontFamily: 'font-mplus-bold', fontSize: 18 }}>ã¡ã‚…ã†ã—</Text>
                  </TouchableOpacity>
                </View>
              </View>
            </View>
          )}

          {/* åŠ±ã¾ã—ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ */}
          {showEncouragement && (
            <>
              {/* ãƒãƒƒã‚¯ãƒ‰ãƒ­ãƒƒãƒ— */}
              <View
                style={{
                  position: 'absolute',
                  top: 0,
                  bottom: 0,
                  left: 0,
                  right: 0,
                  justifyContent: 'center',
                  alignItems: 'center',
                  backgroundColor: 'rgba(0, 0, 0, 0.5)',
                  zIndex: 999,
                }}>
                <Animated.View
                  style={{
                    width: 300,
                    transform: [
                      {
                        scale: encouragementAnim.interpolate({
                          inputRange: [0, 1],
                          outputRange: [0.8, 1],
                        }),
                      },
                    ],
                    opacity: encouragementAnim.interpolate({
                      inputRange: [0, 1],
                      outputRange: [0, 1],
                    }),
                    backgroundColor: 'white',
                    padding: 20,
                    borderRadius: 15,
                    alignItems: 'center',
                    shadowColor: '#000',
                    shadowOffset: { width: 0, height: 2 },
                    shadowOpacity: 0.25,
                    shadowRadius: 4,
                    elevation: 5,
                    zIndex: 1000,
                  }}>
                  <Image source={require('../../assets/temp/elder-worried.png')} style={{ width: 120, height: 120, marginBottom: 10 }} />
                  <Text style={{ fontSize: 24, fontFamily: 'font-mplus-bold', color: '#4CAF50', marginBottom: 10, textAlign: 'center' }}>
                    ã™ã”ã„ï¼
                  </Text>
                  <Text style={{ fontSize: 16, fontFamily: 'font-mplus', color: '#666', textAlign: 'center', marginBottom: 20 }}>
                    {currentEncouragementCount}ã‚‚ã‚“ã‚ ãŠã‚ã£ãŸã‚ˆï¼{'\n'}ã“ã®ã¡ã‚‡ã†ã—ã§ ãŒã‚“ã°ã‚ã†ï¼
                  </Text>
                  <TouchableOpacity
                    onPress={handleEncouragementContinue}
                    style={{
                      backgroundColor: '#4CAF50',
                      paddingVertical: 10,
                      paddingHorizontal: 30,
                      borderRadius: 25,
                    }}>
                    <Text style={{ color: 'white', fontSize: 18, fontFamily: 'font-mplus-bold' }}>ã¤ãã¸</Text>
                  </TouchableOpacity>
                </Animated.View>
              </View>
            </>
          )}

          {/* æ‹—éŸ³è¡¨ç¤º */}
          <View
            style={{
              flex: 1,
              justifyContent: 'center',
              alignItems: 'center',
            }}>
            {/* æ–‡å­—ã®èƒŒæ™¯å†† */}
            <View
              style={{
                position: 'absolute',
                width: '80%',
                height: 240,
                borderRadius: 24,
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                justifyContent: 'center',
                alignItems: 'center',
                shadowColor: '#000',
                shadowOffset: { width: 0, height: 4 },
                shadowOpacity: 0.2,
                shadowRadius: 8,
                elevation: 5,
              }}
            />

            <Animated.Text
              style={{
                fontFamily: 'font-mplus-bold',
                fontSize: 120,
                color: '#333',
                transform: [{ scale: characterScale }],
                textShadowColor: 'rgba(255, 255, 255, 0.8)',
                textShadowOffset: { width: 2, height: 2 },
                textShadowRadius: 4,
              }}>
              {currentYoon}
            </Animated.Text>
          </View>

          {/* éŒ²éŸ³ãƒœã‚¿ãƒ³ */}
          <View
            style={{
              alignItems: 'center',
              marginBottom: 40,
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              padding: 20,
              borderRadius: 20,
              shadowColor: '#000',
              shadowOffset: { width: 0, height: 2 },
              shadowOpacity: 0.1,
              shadowRadius: 4,
              elevation: 3,
            }}>
            {/* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã¯å‰Šé™¤ï¼ˆå­ä¾›ã‚’æ€¥ã‹ã•ãªã„ãŸã‚ï¼‰ */}
            <TouchableOpacity
              onPress={stopRecording}
              disabled={isProcessingAI || isTransitioning || (!isRecording && results.length > 0)}
              style={{
                width: 120,
                height: 120,
                borderRadius: 60,
                backgroundColor: isProcessingAI || isTransitioning || (!isRecording && results.length > 0) ? '#999' : (isRecording ? '#E86A33' : '#41644A'),
                justifyContent: 'center',
                alignItems: 'center',
                shadowColor: '#000',
                shadowOffset: { width: 0, height: 4 },
                shadowOpacity: 0.3,
                shadowRadius: 5,
                elevation: 6,
              }}>
              {isProcessingAI || isTransitioning ? (
                <MaterialCommunityIcons name='dots-horizontal' size={60} color='#FFF' />
              ) : isRecording ? (
                <MaterialCommunityIcons name='stop' size={60} color='#FFF' />
              ) : (
                <MaterialCommunityIcons name='microphone' size={60} color='#FFF' />
              )}
            </TouchableOpacity>
            <Text
              style={{
                fontFamily: 'font-mplus',
                fontSize: 16,
                color: '#41644A',
                marginTop: 10,
                textShadowColor: 'rgba(255, 255, 255, 0.8)',
                textShadowOffset: { width: 1, height: 1 },
                textShadowRadius: 2,
              }}>
              {isProcessingAI ? 'ã—ã‚‡ã‚Šã¡ã‚…ã†...' : (isTransitioning ? 'ã˜ã‚…ã‚“ã³ã¡ã‚…ã†...' : (isRecording ? 'ã‚ˆã¿ãŠã‚ã£ãŸã‚‰ ã‚¿ãƒƒãƒ—' : (results.length === 0 ? 'ãŸã£ã·ã—ã¦ ã™ãŸãƒ¼ã¨' : 'ã˜ã‚…ã‚“ã³ã¡ã‚…ã†...')))}
            </Text>
            {isAIReady && (
              <Text
                style={{
                  fontFamily: 'font-mplus',
                  fontSize: 12,
                  color: '#999',
                  marginTop: 5,
                }}>
                AI {isAIReady ? 'ã˜ã‚…ã‚“ã³OK' : 'ã˜ã‚…ã‚“ã³ã¡ã‚…ã†'}
              </Text>
            )}
          </View>
        </View>
      </ImageBackground>
    </SafeAreaView>
  );
}
